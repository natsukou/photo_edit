<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•é˜¿é‡Œäº‘API</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .info { color: #17a2b8; }
  </style>
</head>
<body>
  <h1>ğŸ§ª é˜¿é‡Œäº‘AI API æµ‹è¯•å·¥å…·</h1>
  
  <div class="test-section">
    <h2>1. æµ‹è¯•å›¾ç‰‡è¯†åˆ«API</h2>
    <p>ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼Œæµ‹è¯•é˜¿é‡Œäº‘é€šä¹‰åƒé—®è§†è§‰æ¨¡å‹çš„è¯†åˆ«èƒ½åŠ›</p>
    <input type="file" id="testImage" accept="image/*">
    <button onclick="testRecognition()">å¼€å§‹æµ‹è¯•</button>
    <div class="log" id="log1"></div>
  </div>
  
  <div class="test-section">
    <h2>2. æµ‹è¯•API Key</h2>
    <p>æ£€æŸ¥API Keyæ˜¯å¦æœ‰æ•ˆ</p>
    <input type="text" id="apiKeyInput" placeholder="sk-xxxxxxxx" style="width: 400px; padding: 8px;">
    <button onclick="testApiKey()">éªŒè¯API Key</button>
    <div class="log" id="log2"></div>
  </div>
  
  <div class="test-section">
    <h2>3. å¿«é€Ÿæµ‹è¯•</h2>
    <p>ä½¿ç”¨ç¤ºä¾‹å›¾ç‰‡å¿«é€Ÿæµ‹è¯•APIè¿æ¥</p>
    <button onclick="quickTest()">ä¸€é”®æµ‹è¯•</button>
    <div class="log" id="log3"></div>
  </div>

  <script src="js/alicloud.js"></script>
  <script>
    function log(id, message, type = 'info') {
      const logEl = document.getElementById(id);
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      logEl.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function clearLog(id) {
      document.getElementById(id).innerHTML = '';
    }

    async function testRecognition() {
      clearLog('log1');
      const fileInput = document.getElementById('testImage');
      
      if (!fileInput.files || !fileInput.files[0]) {
        log('log1', 'âŒ è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡', 'error');
        return;
      }
      
      log('log1', 'ğŸ“¸ æ­£åœ¨è¯»å–å›¾ç‰‡...', 'info');
      const file = fileInput.files[0];
      log('log1', `æ–‡ä»¶å: ${file.name}, å¤§å°: ${(file.size / 1024).toFixed(2)}KB`, 'info');
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64Image = e.target.result;
        log('log1', `âœ… å›¾ç‰‡è¯»å–æˆåŠŸï¼Œå¤§å°: ${(file.size / 1024).toFixed(2)}KB`, 'success');
        log('log1', `Base64é•¿åº¦: ${base64Image.length} å­—ç¬¦`, 'info');
        
        log('log1', 'ğŸš€ å¼€å§‹è°ƒç”¨é˜¿é‡Œäº‘API...', 'info');
        log('log1', `APIåœ°å€: ${AliCloud.baseURL}`, 'info');
        log('log1', `API Key: ${AliCloud.apiKey.substring(0, 15)}...`, 'info');
        log('log1', `æ¨¡å‹: qwen-vl-plus`, 'info');
        
        const startTime = Date.now();
        
        try {
          // ç›´æ¥è°ƒç”¨APIï¼Œä¸ä½¿ç”¨AliCloudå°è£…ï¼Œä»¥ä¾¿è·å–è¯¦ç»†é”™è¯¯
          log('log1', 'æ­£åœ¨å‘é€è¯·æ±‚...', 'info');
          
          // ç§»é™¤base64å‰ç¼€
          let imageData = base64Image;
          if (base64Image.startsWith('data:image')) {
            imageData = base64Image.split(',')[1];
            log('log1', `å·²ç§»é™¤Base64å‰ç¼€ï¼Œå‰©ä½™é•¿åº¦: ${imageData.length}`, 'info');
          }
          
          const requestBody = {
            model: 'qwen-vl-plus',
            input: {
              messages: [
                {
                  role: 'user',
                  content: [
                    { image: imageData },
                    { text: 'è¯·è¯†åˆ«è¿™å¼ ç…§ç‰‡çš„æ‹æ‘„é¢˜æå’Œé£æ ¼ç‰¹å¾ï¼Œä»ä»¥ä¸‹é¢˜æä¸­é€‰æ‹©ä¸€ä¸ªï¼šäººåƒæ‘„å½±ã€é£å…‰æ‘„å½±ã€å»ºç­‘æ‘„å½±ã€å® ç‰©æ‘„å½±ã€ç¾é£Ÿæ‘„å½±ã€è¡—æ‹æ‘„å½±ã€äº§å“æ‘„å½±ã€é™ç‰©æ‘„å½±ã€èŠ±å‰æ‘„å½±ã€å¤œæ™¯æ‘„å½±ã€‚ç„¶åä»ä»¥ä¸‹é£æ ¼ä¸­é€‰æ‹©ä¸€ä¸ªï¼šæ—¥ç³»å°æ¸…æ–°ã€å¤å¤æ¸¯é£ã€ç”µå½±æ„Ÿã€èƒ¶ç‰‡é£ã€INSé£ã€æš—é»‘ç³»ã€é«˜çº§æ„Ÿã€è«å…°è¿ªè‰²ã€èµ›åšæœ‹å…‹ã€æ²¹ç”»è´¨æ„Ÿã€‚è¯·ç›´æ¥å›ç­”"é¢˜æ: XXX, é£æ ¼: XXX"çš„æ ¼å¼ã€‚' }
                  ]
                }
              ]
            },
            parameters: {
              result_format: 'message'
            }
          };
          
          log('log1', `è¯·æ±‚ä½“å¤§å°: ${JSON.stringify(requestBody).length} å­—èŠ‚`, 'info');
          
          const response = await fetch(`${AliCloud.baseURL}/services/aigc/multimodal-generation/generation`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${AliCloud.apiKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
          });
          
          const endTime = Date.now();
          const duration = ((endTime - startTime) / 1000).toFixed(2);
          
          log('log1', `APIå“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
          log('log1', `å“åº”æ—¶é—´: ${duration}ç§’`, 'info');
          
          const data = await response.json();
          log('log1', `å“åº”æ•°æ®: ${JSON.stringify(data).substring(0, 200)}...`, 'info');
          
          if (response.ok && data.output && data.output.choices && data.output.choices.length > 0) {
            const content = data.output.choices[0].message.content;
            log('log1', 'âœ… APIè°ƒç”¨æˆåŠŸï¼', 'success');
            log('log1', `AIè¯†åˆ«ç»“æœ: ${content}`, 'success');
            
            // è§£æç»“æœ
            const categories = ['äººåƒæ‘„å½±', 'é£å…‰æ‘„å½±', 'å»ºç­‘æ‘„å½±', 'å® ç‰©æ‘„å½±', 'ç¾é£Ÿæ‘„å½±', 'è¡—æ‹æ‘„å½±', 'äº§å“æ‘„å½±', 'é™ç‰©æ‘„å½±', 'èŠ±å‰æ‘„å½±', 'å¤œæ™¯æ‘„å½±'];
            const styles = ['æ—¥ç³»å°æ¸…æ–°', 'å¤å¤æ¸¯é£', 'ç”µå½±æ„Ÿ', 'èƒ¶ç‰‡é£', 'INSé£', 'æš—é»‘ç³»', 'é«˜çº§æ„Ÿ', 'è«å…°è¿ªè‰²', 'èµ›åšæœ‹å…‹', 'æ²¹ç”»è´¨æ„Ÿ'];
            
            let category = 'æœªè¯†åˆ«';
            let style = 'æœªè¯†åˆ«';
            
            categories.forEach(cat => {
              if (content.includes(cat)) category = cat;
            });
            
            styles.forEach(sty => {
              if (content.includes(sty)) style = sty;
            });
            
            log('log1', `è§£æç»“æœ: é¢˜æ=${category}, é£æ ¼=${style}`, 'success');
            
            // è´¹ç”¨ä¼°ç®—
            const estimatedCost = (imageData.length / 1000 * 0.04 / 1000).toFixed(4);
            log('log1', `ä¼°è®¡è´¹ç”¨: ï¿¥${estimatedCost} (æŒ‰ï¿¥0.04/åƒtokensè®¡ç®—)`, 'info');
            
          } else if (data.code) {
            log('log1', `âŒ APIé”™è¯¯`, 'error');
            log('log1', `é”™è¯¯ç : ${data.code}`, 'error');
            log('log1', `é”™è¯¯ä¿¡æ¯: ${data.message}`, 'error');
            
            // å¸¸è§é”™è¯¯åˆ†æ
            if (data.code === 'InvalidApiKey') {
              log('log1', 'åŸå› : API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ', 'error');
              log('log1', 'è§£å†³: ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°æ£€æŸ¥API KeyçŠ¶æ€', 'info');
            } else if (data.code === 'InsufficientBalance') {
              log('log1', 'åŸå› : è´¦æˆ·ä½™é¢ä¸è¶³', 'error');
              log('log1', 'è§£å†³: å……å€¼æˆ–å‡çº§å¥—é¤', 'info');
            } else if (data.code === 'Throttling.RateQuota') {
              log('log1', 'åŸå› : è¯·æ±‚é¢‘ç‡è¿‡é«˜', 'error');
              log('log1', 'è§£å†³: ç¨åé‡è¯•æˆ–å‡çº§é…é¢', 'info');
            }
          } else {
            log('log1', 'âŒ APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸', 'error');
            log('log1', JSON.stringify(data, null, 2), 'error');
          }
        } catch (error) {
          const endTime = Date.now();
          const duration = ((endTime - startTime) / 1000).toFixed(2);
          
          log('log1', `âŒ APIè°ƒç”¨å¤±è´¥ (è€—æ—¶: ${duration}ç§’)`, 'error');
          log('log1', `é”™è¯¯ç±»å‹: ${error.name}`, 'error');
          log('log1', `é”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
          
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            log('log1', 'åŸå› : ç½‘ç»œè¿æ¥å¤±è´¥æˆ–CORSé—®é¢˜', 'error');
            log('log1', 'è§£å†³: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–åœ¨åç«¯é…ç½®CORS', 'info');
          }
        }
      };
      
      reader.onerror = () => {
        log('log1', 'âŒ å›¾ç‰‡è¯»å–å¤±è´¥', 'error');
      };
      
      reader.readAsDataURL(file);
    }

    async function testApiKey() {
      clearLog('log2');
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      
      if (!apiKey) {
        log('log2', 'âŒ è¯·è¾“å…¥API Key', 'error');
        return;
      }
      
      log('log2', `ğŸ”‘ æµ‹è¯•API Key: ${apiKey.substring(0, 10)}...`, 'info');
      
      try {
        const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'qwen-turbo',
            input: {
              messages: [
                { role: 'user', content: 'ä½ å¥½' }
              ]
            }
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.output) {
          log('log2', 'âœ… API Key æœ‰æ•ˆï¼', 'success');
          log('log2', `æ¨¡å‹å“åº”: ${data.output.choices[0].message.content}`, 'info');
        } else if (data.code) {
          log('log2', `âŒ API Key æ— æ•ˆ`, 'error');
          log('log2', `é”™è¯¯ç : ${data.code}`, 'error');
          log('log2', `é”™è¯¯ä¿¡æ¯: ${data.message}`, 'error');
        } else {
          log('log2', 'âš ï¸  æœªçŸ¥å“åº”æ ¼å¼', 'error');
          log('log2', JSON.stringify(data, null, 2), 'info');
        }
      } catch (error) {
        log('log2', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
      }
    }

    async function quickTest() {
      clearLog('log3');
      log('log3', 'ğŸš€ å¼€å§‹å¿«é€Ÿæµ‹è¯•...', 'info');
      
      // ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾ç‰‡ (100x100px çš„çº¯ç™½è‰²PNG)
      const testImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
      
      log('log3', 'ä½¿ç”¨æµ‹è¯•å›¾ç‰‡ï¼ˆ1x1px çº¯ç™½è‰²ï¼‰', 'info');
      log('log3', `API Key: ${AliCloud.apiKey.substring(0, 15)}...`, 'info');
      log('log3', `APIåœ°å€: ${AliCloud.baseURL}`, 'info');
      log('log3', `æ¨¡å‹: qwen-vl-plus`, 'info');
      
      const startTime = Date.now();
      
      try {
        // ç›´æ¥è°ƒç”¨API
        let imageData = testImage.split(',')[1];
        
        const requestBody = {
          model: 'qwen-vl-plus',
          input: {
            messages: [
              {
                role: 'user',
                content: [
                  { image: imageData },
                  { text: 'è¯·æè¿°è¿™å¼ å›¾ç‰‡ã€‚' }
                ]
              }
            ]
          },
          parameters: {
            result_format: 'message'
          }
        };
        
        log('log3', 'æ­£åœ¨å‘é€æµ‹è¯•è¯·æ±‚...', 'info');
        
        const response = await fetch(`${AliCloud.baseURL}/services/aigc/multimodal-generation/generation`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${AliCloud.apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        const endTime = Date.now();
        const duration = ((endTime - startTime) / 1000).toFixed(2);
        
        log('log3', `HTTPçŠ¶æ€ç : ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
        log('log3', `å“åº”æ—¶é—´: ${duration}ç§’`, 'info');
        
        const data = await response.json();
        
        if (response.ok && data.output && data.output.choices) {
          log('log3', 'âœ… å¿«é€Ÿæµ‹è¯•æˆåŠŸï¼APIè¿æ¥æ­£å¸¸', 'success');
          log('log3', `AIå“åº”: ${data.output.choices[0].message.content}`, 'success');
          log('log3', '', 'info');
          log('log3', 'âœ… ç»“è®º: é˜¿é‡Œäº‘é€šä¹‰åƒé—®è§†è§‰æ¨¡å‹å·¥ä½œæ­£å¸¸ï¼', 'success');
          log('log3', 'ä½ å¯ä»¥å®‰å¿ƒä½¿ç”¨AIå›¾ç‰‡è¯†åˆ«åŠŸèƒ½ã€‚', 'success');
          
          // æ˜¾ç¤ºä½¿ç”¨ç»Ÿè®¡
          if (data.usage) {
            log('log3', '', 'info');
            log('log3', `Tokenæ¶ˆè€—: è¾“å…¥=${data.usage.input_tokens || 0}, è¾“å‡º=${data.usage.output_tokens || 0}`, 'info');
            const totalTokens = (data.usage.input_tokens || 0) + (data.usage.output_tokens || 0);
            const cost = (totalTokens / 1000 * 0.04).toFixed(4);
            log('log3', `é¢„ä¼°è´¹ç”¨: ï¿¥${cost}`, 'info');
          }
        } else if (data.code) {
          log('log3', 'âŒ å¿«é€Ÿæµ‹è¯•å¤±è´¥', 'error');
          log('log3', `é”™è¯¯ç : ${data.code}`, 'error');
          log('log3', `é”™è¯¯ä¿¡æ¯: ${data.message}`, 'error');
          log('log3', '', 'info');
          
          // å¸¸è§é”™è¯¯åˆ†æ
          if (data.code === 'InvalidApiKey') {
            log('log3', 'âŒ é—®é¢˜: API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ', 'error');
            log('log3', 'ğŸ”§ è§£å†³:', 'info');
            log('log3', '1. ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°: https://dashscope.console.aliyun.com/', 'info');
            log('log3', '2. æ£€æŸ¥API KeyçŠ¶æ€', 'info');
            log('log3', '3. å¦‚æœè¿‡æœŸï¼Œé‡æ–°ç”Ÿæˆå¹¶æ›´æ–°åˆ° js/alicloud.js', 'info');
          } else if (data.code === 'InsufficientBalance') {
            log('log3', 'âŒ é—®é¢˜: è´¦æˆ·ä½™é¢ä¸è¶³', 'error');
            log('log3', 'ğŸ”§ è§£å†³:', 'info');
            log('log3', '1. å……å€¼æˆ–è´­ä¹°å¥—é¤', 'info');
            log('log3', '2. æˆ–ä½¿ç”¨é™çº§æ–¹æ¡ˆï¼ˆè®©ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©é£æ ¼ï¼‰', 'info');
          } else if (data.code === 'Throttling.RateQuota') {
            log('log3', 'âŒ é—®é¢˜: è¯·æ±‚é¢‘ç‡è¿‡é«˜', 'error');
            log('log3', 'ğŸ”§ è§£å†³:', 'info');
            log('log3', '1. ç¨åé‡è¯•', 'info');
            log('log3', '2. æˆ–å‡çº§APIé…é¢', 'info');
          } else {
            log('log3', 'âŒ æœªçŸ¥é”™è¯¯ï¼Œè¯·æŸ¥çœ‹é˜¿é‡Œäº‘æ–‡æ¡£', 'error');
          }
        } else {
          log('log3', 'âŒ APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸', 'error');
          log('log3', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        const endTime = Date.now();
        const duration = ((endTime - startTime) / 1000).toFixed(2);
        
        log('log3', `âŒ æµ‹è¯•å¤±è´¥ (è€—æ—¶: ${duration}ç§’)`, 'error');
        log('log3', `é”™è¯¯ç±»å‹: ${error.name}`, 'error');
        log('log3', `é”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
        log('log3', '', 'info');
        log('log3', 'å¸¸è§é—®é¢˜ï¼š', 'info');
        log('log3', '1. API Key æ˜¯å¦æœ‰æ•ˆï¼Ÿ', 'info');
        log('log3', '2. æ˜¯å¦æœ‰ç½‘ç»œè¿æ¥ï¼Ÿ', 'info');
        log('log3', '3. æ˜¯å¦è¢«CORSç­–ç•¥é˜»æ­¢ï¼Ÿ', 'info');
        log('log3', '4. é˜¿é‡Œäº‘æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Ÿ', 'info');
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå½“å‰é…ç½®
    window.onload = () => {
      document.getElementById('apiKeyInput').value = AliCloud.apiKey || '';
      console.log('é˜¿é‡Œäº‘APIæµ‹è¯•å·¥å…·å·²åŠ è½½');
      console.log('å½“å‰API Key:', AliCloud.apiKey);
      console.log('å½“å‰APIåœ°å€:', AliCloud.baseURL);
    };
  </script>
</body>
</html>
